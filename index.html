<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Christmas Card</title>

<style>
:root{
  --radius: 18px;
  --ease: cubic-bezier(.2,.95,.15,1);
  --shadow: 0 22px 80px rgba(0,0,0,.45);
}

/* RESET */
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  background: radial-gradient(1200px 700px at 50% 20%, #2b2b2b, #070707);
  overflow:hidden;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

/* SNOW – PHỦ ẢNH */
#snow{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:9999;
}

/* STAGE */
.stage{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  perspective:1400px;
  z-index:1;
  padding:
    env(safe-area-inset-top)
    env(safe-area-inset-right)
    env(safe-area-inset-bottom)
    env(safe-area-inset-left);
}

/* CARD – AUTO RESIZE MOBILE */
.card{
  width: min(96vw, 900px);
  aspect-ratio: 3 / 4;
  max-height: 88dvh; /* dynamic viewport */

  position:relative;
  transform-style:preserve-3d;
  filter: drop-shadow(var(--shadow));

  /* AUTO ZOOM (IDLE) */
  animation: slowZoom 16s ease-in-out infinite;
}

/* ZOOM KHI MỞ */
.card.open{
  animation: slowZoomOpen 22s ease-in-out infinite;
}

/* LAYERS */
.layer{
  position:absolute;
  inset:0;
  border-radius:var(--radius);
  overflow:hidden;
  transform-style:preserve-3d;
  will-change:transform, opacity, filter;
}

.bg{
  position:absolute;
  inset:0;
  background-size: contain;      /* ✅ không cắt chữ */
  background-position: center;
  background-repeat: no-repeat;
  background-color: #000;
}

/* IMAGES */
.bg.cover{ background-image:url("cover.png"); }
.bg.content{ background-image:url("content.png"); }

/* CONTENT */
.contentLayer{
  opacity:0;
  transform:scale(0.97);
  filter:blur(2px);
  transition:
    transform 900ms var(--ease),
    opacity 700ms ease,
    filter 700ms ease;
}
.card.open .contentLayer{
  opacity:1;
  transform:scale(1);
  filter:blur(0);
}

/* COVER SPIN */
.coverLayer{
  opacity:1;
  transform:rotateY(0deg) scale(1);
  backface-visibility:hidden;
  transition:
    transform 1150ms var(--ease),
    opacity 600ms ease,
    filter 600ms ease;
  z-index:2;
}
.card.open .coverLayer{
  transform:rotateY(360deg) scale(.92);
  opacity:0;
  filter:blur(2px);
  pointer-events:none;
}
.coverLayer::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(120deg, rgba(255,255,255,.12), transparent 45%);
  mix-blend-mode:screen;
}

/* SPEAKER */
.speaker{
  position:fixed;
  top:calc(env(safe-area-inset-top) + 12px);
  right:calc(env(safe-area-inset-right) + 12px);
  width:46px;
  height:46px;
  border-radius:50%;
  background:rgba(255,255,255,.15);
  backdrop-filter:blur(10px);
  display:grid;
  place-items:center;
  cursor:pointer;
  z-index:10000;
}
.speaker svg{
  width:22px;
  height:22px;
  fill:white;
}
.speaker.muted::after{
  content:"";
  position:absolute;
  width:10px;
  height:10px;
  background:#ff4d4d;
  border-radius:50%;
  top:8px;
  right:8px;
}

/* TAP HINT */
.tap-hint{
  position:fixed;
  bottom:calc(env(safe-area-inset-bottom) + 18px);
  left:50%;
  transform:translateX(-50%);
  padding:8px 16px;
  border-radius:999px;
  background:rgba(0,0,0,.45);
  color:#fff;
  font-size:14px;
  backdrop-filter:blur(6px);
  z-index:10000;
  animation:pulse 1.6s ease-in-out infinite;
  pointer-events:none;
}

/* ANIMATIONS */
@keyframes pulse{
  0%,100%{ opacity:.55; transform:translateX(-50%) scale(1); }
  50%{ opacity:.9; transform:translateX(-50%) scale(1.05); }
}
@keyframes slowZoom{
  0%{ transform:scale(1); }
  50%{ transform:scale(1.035); }
  100%{ transform:scale(1); }
}
@keyframes slowZoomOpen{
  0%{ transform:scale(1); }
  50%{ transform:scale(1.065); }
  100%{ transform:scale(1); }
}
</style>
</head>

<body>

<canvas id="snow"></canvas>

<button class="speaker muted" id="speakerBtn" aria-label="Music">
<svg viewBox="0 0 24 24">
<path d="M3 10v4a2 2 0 0 0 2 2h3l5 4a1 1 0 0 0 1.62-.78V4.78A1 1 0 0 0 13 4l-5 4H5a2 2 0 0 0-2 2zm16.5 2a4.5 4.5 0 0 0-2.19-3.86.75.75 0 1 0-.77 1.29A3 3 0 0 1 18 12a3 3 0 0 1-1.46 2.57.75.75 0 1 0 .77 1.29A4.5 4.5 0 0 0 19.5 12z"/>
</svg>
</button>

<div class="stage">
  <div class="card" id="card">
    <div class="layer contentLayer">
      <div class="bg content"></div>
    </div>
    <div class="layer coverLayer">
      <div class="bg cover"></div>
    </div>
  </div>
</div>

<div class="tap-hint" id="tapHint">Tap to open card</div>

<audio id="bgm" loop preload="auto">
  <source src="music.mp3" type="audio/mpeg">
</audio>

<script>
(() => {
  /* FORCE RESIZE – MOBILE SAFE */
  const card = document.getElementById("card");
  function forceResize(){
    card.style.maxHeight = (window.innerHeight * 0.88) + "px";
  }
  window.addEventListener("resize", forceResize);
  window.addEventListener("orientationchange", forceResize);
  forceResize();

  /* CARD OPEN */
  const tapHint = document.getElementById("tapHint");
  let open = false;
  let interacted = false;

  card.addEventListener("click", () => {
    if(!interacted){
      interacted = true;
      setTimeout(autoPlayMusic, 2000);
    }
    open = !open;
    card.classList.toggle("open", open);
    if(open) tapHint.style.display="none";
    if(musicOn) tryPlay();
  });

  /* MUSIC */
  const bgm = document.getElementById("bgm");
  const speaker = document.getElementById("speakerBtn");
  let musicOn = false;

  async function tryPlay(){ try{ await bgm.play(); }catch(e){} }
  function stop(){ bgm.pause(); }

  function renderSpeaker(){
    speaker.classList.toggle("muted", !musicOn);
  }

  async function autoPlayMusic(){
    musicOn = true;
    renderSpeaker();
    await tryPlay();
  }

  speaker.addEventListener("click", async e => {
    e.stopPropagation();
    musicOn = !musicOn;
    renderSpeaker();
    musicOn ? await tryPlay() : stop();
  });

  /* SNOW */
  const canvas = document.getElementById("snow");
  const ctx = canvas.getContext("2d");

  function resizeSnow(){
    canvas.width = innerWidth;
    canvas.height = innerHeight;
  }
  resizeSnow();
  addEventListener("resize", resizeSnow);

  const flakes = Array.from({length:300}, () => ({
    x: Math.random()*innerWidth,
    y: Math.random()*innerHeight,
    r: Math.random()*2+0.6,
    v: Math.random()*0.4+0.1
  }));

  function snow(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="rgba(255,255,255,.85)";
    ctx.beginPath();
    flakes.forEach(f=>{
      ctx.moveTo(f.x,f.y);
      ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
      f.y+=f.v;
      if(f.y>innerHeight){
        f.y=0;
        f.x=Math.random()*innerWidth;
      }
    });
    ctx.fill();
    requestAnimationFrame(snow);
  }
  snow();
})();
</script>

</body>
</html>

